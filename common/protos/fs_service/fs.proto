syntax = "proto3";

// ----------------------------------------------------
// Service 1: Kernel (Client Gateway)
// User (Client SDK) talks to this 
// ----------------------------------------------------
service FSMasterService {
    rpc Mount(MountRequest) returns (StatusResponse);
    rpc UnMount(MountRequest) returns (StatusResponse);
    
    rpc Open(OpenRequest) returns (OpenResponse);
    rpc Close(CloseRequest) returns (StatusResponse);
    rpc Read(ReadRequest) returns (ReadResponse);
    rpc Write(WriteRequest) returns (StatusResponse);
    rpc DeleteFile(DeleteFileRequest) returns (StatusResponse);
    
    rpc Mkdir(MkdirRequest) returns (StatusResponse);
    rpc Rmdir(RmdirRequest) returns (StatusResponse);
    rpc Ls(LsRequest) returns (LsResponse);
}
// 1)
message MountRequest { string user_id = 1; }
message OpenRequest  { string user_id = 1; string path = 2; string mode = 3; }
message OpenResponse { int32 fd = 1; string error = 2; }
message CloseRequest { string user_id = 1; int32 fd = 2; }
// 2)
message ReadRequest {
    string user_id = 1;
    int32 fd = 2;
    int32 count = 3;
}
message ReadResponse {
    bytes data = 1;
    int32 bytes_read = 2;
}
message WriteRequest {
    string user_id = 1;
    int32 fd = 2;
    uint64 offset = 3;
    bytes data = 4;
}
message DeleteFileRequest {
    string user_id = 1;
    string path = 2;
}
// 3)
message MkdirRequest { string user_id = 1; string path = 2; }
message RmdirRequest { string user_id = 1; string path = 2; }
message LsRequest    { string user_id = 1; string path = 2; }
message LsResponse   { bool success = 1; string error = 2; repeated string files = 3; }

// ----------------------------------------------------
// Service 2: FS Server (Data Node / Block Server)
// Master talks to this to read/write raw block data
// Each datanode stores fixed-size blocks as .img files
// Future: Page cache optimizations can be added here
// ----------------------------------------------------
service FSServerService {
    rpc ReadBlockDataServer(ReadBlockRequest) returns (ReadBlockResponse);
    rpc WriteBlockDataServer(WriteBlockRequest) returns (StatusResponse);
    rpc DeleteBlockDataServer(DeleteBlockRequest) returns (StatusResponse);
    rpc GetBlockInfoDataServer(GetBlockInfoRequest) returns (GetBlockInfoResponse);
    rpc HeartBeatDataServer(HeartBeatRequest) returns (HeartBeatResponse);
}

message ReadBlockRequest {
    uint64 block_uuid = 1;      // Unique identifier for the block
    uint64 offset = 2;          // Offset within block (for future page cache)
    uint64 length = 3;          // Number of bytes to read (0 = entire block)
}

message ReadBlockResponse {
    bool success = 1;
    bytes data = 2;
    string error = 3;
    uint64 bytes_read = 4;
}

message WriteBlockRequest {
    uint64 block_uuid = 1;      // Unique identifier for the block
    bytes data = 2;             // Data to write
    uint64 offset = 3;          // Offset within block (for future page cache)
}

message DeleteBlockRequest {
    uint64 block_uuid = 1;      // Block to delete
}

message GetBlockInfoRequest {
    uint64 block_uuid = 1;      // Block to get info for
}

message GetBlockInfoResponse {
    bool exists = 1;
    uint64 size = 2;            // Block size in bytes
    string created_at = 3;      // Creation timestamp
    string checksum = 4;        // For integrity verification
}

message HeartBeatRequest {
    string datanode_id = 1;     // Unique datanode identifier
    repeated uint64 block_uuids = 2;  // Blocks stored on this node
}

message HeartBeatResponse {
    bool success = 1;
    string error = 2;
}

// common
message StatusResponse {
    bool success = 1;
    string error = 2;
}